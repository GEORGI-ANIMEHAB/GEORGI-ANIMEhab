const express = require('express');
const mongoose = require('mongoose');
const path = require('path');
const helmet = require('helmet');
const csrf = require('csurf');
const cookieParser = require('cookie-parser');
const i18next = require('i18next');
const i18nextMiddleware = require('i18next-express-middleware');
const Backend = require('i18next-fs-backend');
const socketIo = require('socket.io');
const http = require('http');
const speakeasy = require('speakeasy');
const qrcode = require('qrcode');

// Модели
const userSchema = new mongoose.Schema({
    username: String,
    email: String,
    password: String,
    isAdmin: Boolean,
    twoFactorSecret: String
});
const User = mongoose.model('User', userSchema);

const contentSchema = new mongoose.Schema({
    title: String,
    description: String,
});
const Content = mongoose.model('Content', contentSchema);

const commentSchema = new mongoose.Schema({
    contentId: { type: mongoose.Schema.Types.ObjectId, ref: 'Content', required: true },
    userId: { type: mongoose.Schema.Types.ObjectId, ref: 'User', required: true },
    text: { type: String, required: true },
    createdAt: { type: Date, default: Date.now }
});
const Comment = mongoose.model('Comment', commentSchema);

// Настройка Express
const app = express();
const server = http.createServer(app);
const io = socketIo(server);

mongoose.connect('mongodb://localhost/your-database', { useNewUrlParser: true, useUnifiedTopology: true });

app.use(express.json());
app.use(express.static(path.join(__dirname, 'public')));
app.use(cookieParser());
app.use(helmet());
app.use(csrf({ cookie: true }));

i18next
    .use(Backend)
    .use(i18nextMiddleware.LanguageDetector)
    .init({
        backend: {
            loadPath: path.join(__dirname, 'locales', '{{lng}}', 'translation.json')
        },
        fallbackLng: 'en',
        preload: ['en', 'fr', 'de'],
    });

app.use(i18nextMiddleware.handle(i18next));

app.use((req, res, next) => {
    res.locals.csrfToken = req.csrfToken();
    next();
});

// Маршруты
app.get('/', (req, res) => {
    res.send(`
        <!DOCTYPE html>
        <html lang="en">
        <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>Главная страница</title>
            <link rel="stylesheet" href="/styles.css">
        </head>
        <body>
            <header>
                <h1>Добро пожаловать на наш сайт</h1>
                <nav>
                    <a href="/">Главная</a>
                    <a href="/search">Поиск</a>
                    <a href="/notifications">Уведомления</a>
                    <a href="/admin">Админ панель</a>
                </nav>
            </header>

            <div class="container">
                <section id="welcome">
                    <h2>Последний контент</h2>
                    <div id="latest-content">
                        <!-- Последний контент будет загружаться сюда -->
                    </div>
                </section>
            </div>
        </body>
        </html>
    `);
});

app.get('/content/:id', (req, res) => {
    res.send(`
        <!DOCTYPE html>
        <html lang="en">
        <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>Контент</title>
            <link rel="stylesheet" href="/styles.css">
        </head>
        <body>
            <header>
                <h1>Контент</h1>
            </header>

            <div class="container">
                <section id="content-details">
                    <h2>Детали контента</h2>
                    <!-- Детали контента будут загружаться сюда -->
                </section>
            </div>
        </body>
        </html>
    `);
});

app.get('/search', (req, res) => {
    res.send(`
        <!DOCTYPE html>
        <html lang="en">
        <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>Поиск</title>
            <link rel="stylesheet" href="/styles.css">
        </head>
        <body>
            <header>
                <h1>Поиск контента</h1>
            </header>

            <div class="container">
                <section id="search">
                    <h2>Найдите что-то</h2>
                    <input type="text" id="search-query" placeholder="Введите запрос...">
                    <button id="search-button">Поиск</button>
                    <div id="search-results">
                        <!-- Результаты поиска будут загружаться сюда -->
                    </div>
                </section>
            </div>

            <script>
                document.getElementById('search-button').addEventListener('click', function () {
                    const query = document.getElementById('search-query').value;
                    fetch(`/search?q=${encodeURIComponent(query)}`)
                        .then(response => response.json())
                        .then(results => {
                            const searchResults = document.getElementById('search-results');
                            searchResults.innerHTML = '';
                            results.forEach(item => {
                                const div = document.createElement('div');
                                div.className = 'search-result-item';
                                div.innerHTML = \`
                                    <h3><a href="/content/\${item._id}">\${item.title}</a></h3>
                                    <p>\${item.description}</p>
                                \`;
                                searchResults.appendChild(div);
                            });
                        });
                });
            </script>
        </body>
        </html>
    `);
});

app.get('/notifications', (req, res) => {
    res.send(`
        <!DOCTYPE html>
        <html lang="en">
        <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>Уведомления</title>
            <link rel="stylesheet" href="/styles.css">
        </head>
        <body>
            <header>
                <h1>Уведомления</h1>
            </header>

            <div class="container">
                <section id="notifications">
                    <h2>Уведомления</h2>
                    <div id="notification-container">
                        <!-- Уведомления будут загружаться сюда -->
                    </div>
                </section>
            </div>

            <script src="/socket.io/socket.io.js"></script>
            <script>
                const socket = io();

                socket.on('notification', function (notification) {
                    const container = document.getElementById('notification-container');
                    const div = document.createElement('div');
                    div.className = 'notification';
                    div.textContent = notification.message;
                    container.appendChild(div);
                });
            </script>
        </body>
        </html>
    `);
});

app.get('/admin', (req, res) => {
    res.send(`
        <!DOCTYPE html>
        <html lang="en">
        <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>Админ панель</title>
            <link rel="stylesheet" href="/styles.css">
        </head>
        <body>
            <header>
                <h1>Админ панель</h1>
            </header>

            <div class="container">
                <section id="admin">
                    <h2>Управление пользователями</h2>
                    <div id="admin-user-list">
                        <!-- Список пользователей будет загружаться сюда -->
                    </div>
                </section>
            </div>

            <script>
                fetch('/admin/users')
                    .then(response => response.json())
                    .then(users => {
                        const userList = document.getElementById('admin-user-list');
                        users.forEach(user => {
                            const div = document.createElement('div');
                            div.className = 'user-item';
                            div.innerHTML = \`
                                <p>\${user.username} - \${user.email}</p>
                                <button onclick="deleteUser('\${user._id}')">Удалить</button>
                            \`;
                            userList.appendChild(div);
                        });
                    });

                function deleteUser(userId) {
                    fetch('/admin/users/' + userId, {
                        method: 'DELETE'
                    })
                    .then(response => response.json())
                    .then(result => {
                        if (result.success) {
                            location.reload();
                        }
                    });
                }
            </script>
        </body>
        </html>
    `);
});

app.post('/setup-2fa', async (req, res) => {
    const secret = speakeasy.generateSecret();
    const user = await User.findById(req.user._id);
    user.twoFactorSecret = secret.base32;
    await user.save();

    qrcode.toDataURL(secret.otpauth_url, (err, data_url) => {
        res.json({ secret: secret.base32, qrCodeUrl: data_url });
    });
});

app.post('/verify-2fa', async (req, res) => {
    const { token } = req.body;
    const user = await User.findById(req.user._id);

    const verified = speakeasy.verify({
        secret: user.twoFactorSecret,
        token,
        encoding: 'base32'
    });

    if (verified) {
        res.json({ success: true });
    } else {
        res.status(400).json({ error: 'Неверный токен' });
    }
});

app.get('/comments/:contentId', async (req, res) => {
    try {
        const comments = await Comment.find({ contentId: req.params.contentId });
        res.json(comments);
    } catch (error) {
        res.status(500).json({ error: 'Ошибка получения комментариев' });
    }
});

app.post('/comments/:contentId', async (req, res) => {
    try {
        const comment = new Comment({
            contentId: req.params.contentId,
            userId: req.user._id,
            text: req.body.text
        });
        await comment.save();
        res.json({ success: true });
    } catch (error) {
        res.status(500).json({ error: 'Ошибка отправки комментария' });
    }
});

io.on('connection', (socket) => {
    console.log('New client connected');
    
    socket.on('sendNotification', (notification) => {
        io.emit('notification', notification);
    });

    socket.on('disconnect', () => {
        console.log('Client disconnected');
    });
});

server.listen(3000, () => {
    console.log('Server listening on port 3000');
});
